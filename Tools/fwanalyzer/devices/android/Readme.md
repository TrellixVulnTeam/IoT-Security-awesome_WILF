# Android OTA Firmware Analysis

The OTA file is a zip file with various files inside, the one file we care about is _payload.bin_.
Payload.bin contains the filesystem images such as _system.img_ and _boot.img_.
The `check_ota.py` script unpacks an OTA file and runs FwAnalyzer on every filesystem image extracted from the OTA file.

## FwAnalyzer Config

The OTA check script requires separate FwAnalyzer configuration files for each filesystem image that is extracted from the OTA file.
The `check_ota.py` script expects a directory that contains FwAnalyzer config files with the same name as the filesystem image but
the toml extensions. For example the config file for _system.img_ needs to be named _[system.toml](system.toml)_.

OTA images contain _system.img_, _vendor.img_, _dsp.img_, and _boot.img_.
All images besides the _boot.img_ are ext4 filesystems and therefore the config file needs to have `FsType` set to `extfs`.
The _boot.img_ will be unpacked to a directory (using the `mkboot` tool), therefore, the _boot.toml_ file needs to have `FsType` set to `dirfs`.

### Android Checks

The files _[android_user_build_checks.toml](android_user_build_checks.toml)_
and _[android_user_build_checks_boot.toml](android_user_build_checks_boot.toml)_
are a collection of very simple checks for Android production builds (user builds).
The config file can be included in custom FwAnalyzer config using the `Include` statement.

The _[android_properties.toml](android_properties.toml)_ file is a collection of `DataExtract`
statements that will extract Android properties from various parts of an Android firmware image.

## Running check\_ota.py

The OTA check fails if FwAnalyzer reports an Offender in any of the filesystem images.
The reports generated by FwAnalyzer are written to _IMAGENAME_out.json_ (e.g. _system_out.json_).

`check_ota.py` arguments:
- `--ota`              string : path to ota file
- `--report`           string : path to report file (will be overwritten)
- `--cfg-path`         string : path to directory containing fwanalyzer config files
- `--cfg-include-path` string : path to directory containing fwanalyzer config include files
- `--fwanalyzer-bin`   string : path to fwanalyzer binary
- `--keep-unpacked`           : keep unpacked data
- `--targets`          string : filesystem targets (e.g.: system boot)

Example:
```sh
$ ls
 system.toml

$ check_ota.py -ota update-ota.zip -cfg-path . -cfg-include-path . --targets system
```

## Required tools
- [extract android ota payload](https://github.com/cyxx/extract_android_ota_payload.git) to extract the fs images from an ota update
- [mkbootimg tools](https://github.com/xiaolu/mkbootimg_tools.git) unpack boot.img to extract kernel, initramfs, etc.
